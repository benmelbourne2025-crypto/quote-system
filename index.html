<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>SignedOn Quote | Phase 2.5</title>

<script src="https://cdn.jsdelivr.net/npm/vue@3.3.4/dist/vue.global.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

<style>
[v-cloak]{display:none}
@media print{
  body{background:#fff}
  .no-print{display:none!important}
  .page-break{page-break-before:always}
}
</style>
</head>

<body class="bg-slate-50">
<div id="app" v-cloak>

<!-- TOP BAR -->
<nav class="bg-slate-900 text-white px-6 py-3 sticky top-0 z-50 no-print">
  <div class="max-w-7xl mx-auto flex justify-between items-center">

    <!-- LEFT -->
    <div class="flex items-center gap-4">
      <div class="font-black text-xl">
        signed<span class="text-pink-500">on</span> Quote
      </div>

      <button @click="saveJSON" class="text-xs font-bold bg-slate-700 px-3 py-1 rounded">
        <i class="fa fa-save mr-1"></i>Save JSON
      </button>

      <label class="text-xs font-bold bg-slate-700 px-3 py-1 rounded cursor-pointer">
        <i class="fa fa-folder-open mr-1"></i>Open
        <input type="file" accept=".json" @change="loadJSON" hidden/>
      </label>
    </div>

    <!-- RIGHT -->
    <div class="flex gap-3">
      <button @click="resetQuote"
        class="bg-red-600 px-4 py-1 rounded text-xs font-bold">
        Reset
      </button>

      <button @click="printQuote"
        class="bg-blue-600 px-6 py-2 rounded font-bold">
        <i class="fa fa-print mr-2"></i>PDF
      </button>
    </div>
  </div>
</nav>

<div class="max-w-7xl mx-auto p-6">

<!-- HEADER -->
<div class="bg-white rounded-xl p-8 shadow border mb-8 text-center">
  <input v-model="quote.title"
    placeholder="PROJECT NAME"
    class="text-3xl font-black text-center w-full outline-none mb-4"/>
  <div class="flex justify-center gap-4">
    <input v-model="quote.client"
      placeholder="Client Name"
      class="bg-slate-100 px-4 py-2 rounded font-bold"/>
    <span class="py-2 text-slate-400 font-medium">
      Date: {{ currentDate }}
    </span>
  </div>
</div>

<!-- SECTIONS -->
<div v-for="(section,sIndex) in quote.sections"
     :key="section.id"
     class="mb-12">

<div class="flex justify-between items-center mb-3 no-print">
  <input v-model="section.title"
    class="font-bold text-lg outline-none"/>
  <button @click="removeSection(sIndex)"
    class="text-slate-300 hover:text-red-500">
    <i class="fa fa-times-circle"></i>
  </button>
</div>

<div class="bg-white rounded-xl border shadow overflow-hidden">
<table class="w-full text-sm">
<thead class="bg-slate-100 text-slate-500 text-xs">
<tr>
  <th class="p-4 text-left">Description</th>
  <th class="w-20">Qty</th>
  <th class="w-28 text-right">Unit</th>
  <th class="w-28 text-right">Total</th>
  <th class="w-16 text-center">Opt</th>
  <th class="w-10 no-print"></th>
</tr>
</thead>

<tbody :ref="el=>bindSortable(el,section.items)"
       class="divide-y">

<tr v-for="item in section.items" :key="item.id">
<td class="p-4">
  <input v-model="item.name"
    list="matList"
    @change="autoFill(item)"
    class="font-bold w-full outline-none"/>
  <input v-model="item.details"
    class="text-xs text-slate-400 w-full outline-none"/>
</td>

<td class="text-center">
  <input type="number" v-model.number="item.qty"
    class="w-16 bg-slate-100 rounded text-center"/>
</td>

<td class="text-right">
  <input type="number" v-model.number="item.price"
    class="w-20 bg-slate-100 rounded text-right"/>
</td>

<td class="text-right font-bold pr-4">
  ${{ lineTotal(item).toFixed(2) }}
</td>

<td class="text-center">
  <input type="checkbox"
    v-if="item.optional"
    v-model="item.selected"/>
</td>

<td class="text-center no-print">
  <button @click="removeItem(section,item)"
    class="text-slate-300 hover:text-red-500">
    <i class="fa fa-trash"></i>
  </button>
</td>
</tr>
</tbody>
</table>

<div class="p-3 bg-slate-50 text-center no-print">
<button @click="addItem(sIndex)"
 class="text-blue-600 font-bold text-xs">
+ ADD LINE
</button>
</div>
</div>
</div>

<!-- TOTAL -->
<div class="flex justify-end border-t pt-8 mb-20">
<div class="w-80 text-right space-y-2">
<div class="flex justify-between text-xs text-slate-400">
<span>Sub Total</span>
<span>${{ subTotal.toFixed(2) }}</span>
</div>
<div class="flex justify-between text-xs text-slate-400">
<span>GST 10%</span>
<span>${{ gst.toFixed(2) }}</span>
</div>
<div class="text-3xl font-black text-blue-600">
${{ grandTotal.toFixed(2) }}
</div>
</div>
</div>

<div class="text-center no-print">
<button @click="addSection"
 class="bg-slate-800 text-white px-8 py-3 rounded-xl font-bold">
+ Add Section
</button>
</div>

<datalist id="matList">
<option v-for="m in database" :value="m.name"></option>
</datalist>

</div>
</div>

<script>
const { createApp, reactive, ref, computed, onMounted } = Vue;
const uid = () => crypto.randomUUID();

const emptyQuote = () => ({
 title:'',
 client:'',
 sections:[
  {
   id:uid(),
   title:'Section 1',
   items:[
    {id:uid(),name:'',details:'',qty:1,price:0,optional:false,selected:true}
   ]
  }
 ]
});

createApp({
setup(){

const database = ref([]);
onMounted(async()=>{
 try{
  const r = await fetch('database.json');
  if(r.ok) database.value = await r.json();
 }catch{}
});

const quote = reactive(emptyQuote());

const autoFill = item=>{
 const f = database.value.find(d=>d.name===item.name);
 if(!f) return;
 item.price=f.sell||0;
 item.details=f.name;
};

const addSection = ()=>quote.sections.push({
 id:uid(),title:'New Section',
 items:[{id:uid(),name:'',details:'',qty:1,price:0,optional:false,selected:true}]
});

const removeSection = i=>quote.sections.splice(i,1);
const addItem = i=>quote.sections[i].items.push(
 {id:uid(),name:'',details:'',qty:1,price:0,optional:true,selected:false}
);
const removeItem = (section,item)=>{
 section.items.splice(section.items.indexOf(item),1);
};

const lineTotal = item =>
 (!item.optional || item.selected)
 ? (item.qty||0)*(item.price||0)
 : 0;

const subTotal = computed(()=>quote.sections
 .reduce((s,sec)=>s+sec.items.reduce((i,it)=>i+lineTotal(it),0),0)
);

const gst = computed(()=>subTotal.value*0.1);
const grandTotal = computed(()=>subTotal.value*1.1);

const bindSortable = (el,list)=>{
 if(!el||el._init) return;
 el._init=true;
 new Sortable(el,{
  animation:150,
  onEnd:e=>{
   list.splice(e.newIndex,0,list.splice(e.oldIndex,1)[0]);
  }
 });
};

const saveJSON = ()=>{
 const blob = new Blob([JSON.stringify(quote,null,2)],{type:'application/json'});
 const a = document.createElement('a');
 a.href = URL.createObjectURL(blob);
 a.download = `Quote-${Date.now()}.json`;
 a.click();
};

const loadJSON = e=>{
 const file = e.target.files[0];
 if(!file) return;
 const reader = new FileReader();
 reader.onload = ev=>{
  Object.assign(quote, JSON.parse(ev.target.result));
 };
 reader.readAsText(file);
};

const resetQuote = ()=>{
 Object.assign(quote, emptyQuote());
};

return{
 quote,database,currentDate:new Date().toLocaleDateString('en-AU'),
 autoFill,addSection,removeSection,addItem,removeItem,
 lineTotal,subTotal,gst,grandTotal,
 bindSortable,saveJSON,loadJSON,resetQuote,
 printQuote:()=>window.print()
};
}
}).mount('#app');
</script>

</body>
</html>
