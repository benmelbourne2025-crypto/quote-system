<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OneDrive Quote Master</title>
    <script src="https://cdn.jsdelivr.net/npm/vue@3.3.4/dist/vue.global.prod.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">

    <style>
        :root { --brand-dark: #1e293b; --brand-blue: #0078D4; /* OneDrive Blue */ }
        body { font-family: 'Inter', sans-serif; background: #f3f2f1; }
        [v-cloak] { display: none; }

        /* Office 风格卡片 */
        .office-card {
            background: white; border: 1px solid #e1dfdd; box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: all 0.2s;
        }
        .office-card:hover { box-shadow: 0 8px 16px rgba(0,0,0,0.1); transform: translateY(-2px); }

        /* 打印优化 */
        @media print {
            @page { margin: 10mm; size: A4; }
            body { background: white; -webkit-print-color-adjust: exact; }
            .no-print, nav, .add-btn, .link-input-area { display: none !important; }
            
            /* 打印时，把链接变成可读的文字或者图标 */
            .attachment-grid { display: block !important; }
            .attachment-item { border: 1px solid #ddd; page-break-inside: avoid; margin-bottom: 5px; }
            
            input, textarea { border: none !important; background: transparent !important; resize: none; }
            /* 隐藏内部成本 */
            .internal-data { display: none !important; }
        }
    </style>
</head>
<body :class="{ 'client-view': viewMode === 'client' }">

<div id="app" v-cloak class="pb-32">
    <nav class="bg-[#0078D4] text-white sticky top-0 z-50 shadow-md no-print">
        <div class="max-w-7xl mx-auto px-4 h-14 flex justify-between items-center text-sm">
            <div class="flex items-center gap-4">
                <div class="grid grid-cols-3 gap-0.5 w-4 h-4 mr-2">
                    <div class="bg-white w-1 h-1" v-for="n in 9"></div>
                </div>
                <span class="text-lg font-bold tracking-tight">Team Quote <span class="font-light opacity-80">for OneDrive</span></span>
                
                <div class="bg-[#005a9e] p-1 rounded flex text-xs font-bold ml-6">
                    <button @click="viewMode = 'internal'" :class="{'bg-white text-[#0078D4]': viewMode === 'internal', 'text-blue-100': viewMode !== 'internal'}" class="px-3 py-1 rounded transition">
                        INTERNAL
                    </button>
                    <button @click="viewMode = 'client'" :class="{'bg-white text-[#0078D4]': viewMode === 'client', 'text-blue-100': viewMode !== 'client'}" class="px-3 py-1 rounded transition">
                        CLIENT PDF
                    </button>
                </div>
            </div>

            <div class="flex gap-2 font-semibold">
                <button @click="actions.saveData" class="hover:bg-[#005a9e] px-3 py-1.5 rounded flex gap-2 items-center transition">
                    <i class="far fa-save"></i> Save JSON
                </button>
                <label class="hover:bg-[#005a9e] px-3 py-1.5 rounded flex gap-2 items-center cursor-pointer transition">
                    <i class="far fa-folder-open"></i> Open JSON
                    <input type="file" @change="actions.loadData" class="hidden" accept=".json">
                </label>
                <button @click="actions.print" class="bg-white text-[#0078D4] hover:bg-slate-100 px-4 py-1.5 rounded flex gap-2 items-center shadow transition ml-4">
                    <i class="fas fa-print"></i> Export PDF
                </button>
            </div>
        </div>
    </nav>

    <main class="max-w-5xl mx-auto mt-8 bg-white min-h-[1100px] shadow-xl rounded-sm overflow-hidden print:shadow-none print:mt-0">
        
        <header class="p-10 border-b border-slate-100 flex justify-between">
            <div class="w-2/3 space-y-4">
                <input v-model="project.title" class="text-3xl font-bold w-full outline-none placeholder-slate-300 text-slate-800" placeholder="Project / Quote Title">
                <div class="grid grid-cols-2 gap-4 max-w-md">
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase">Client</label>
                        <input v-model="project.client" class="block w-full text-sm font-bold text-slate-700 outline-none border-b border-transparent focus:border-blue-500 bg-slate-50 px-2 py-1">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase">Reference</label>
                        <input v-model="project.ref" class="block w-full text-sm font-bold text-slate-700 outline-none border-b border-transparent focus:border-blue-500 bg-slate-50 px-2 py-1">
                    </div>
                </div>
            </div>
            <div class="w-1/3 text-right">
                <div class="text-xs text-slate-400">Date: {{ currentDate }}</div>
                <div class="mt-2 text-4xl text-[#0078D4]"><i class="fab fa-microsoft"></i></div>
            </div>
        </header>

        <div class="p-10">
            <div v-for="(section, sIdx) in project.sections" :key="section.id" class="mb-12 page-break">
                <div class="flex items-center gap-3 mb-6 border-b-2 border-slate-100 pb-2">
                    <div class="bg-slate-800 text-white w-6 h-6 rounded flex items-center justify-center font-bold text-xs">{{ sIdx + 1 }}</div>
                    <input v-model="section.title" class="text-xl font-bold text-slate-800 w-full outline-none bg-transparent" placeholder="Section Name">
                    <button @click="actions.removeSection(sIdx)" class="no-print text-slate-300 hover:text-red-500"><i class="fas fa-trash"></i></button>
                </div>

                <div class="space-y-6">
                    <div v-for="(item, iIdx) in section.items" :key="iIdx" class="bg-white group/item relative border-b border-slate-50 pb-6">
                        
                        <div class="flex gap-6">
                            <div class="flex-grow space-y-2">
                                <div class="flex justify-between">
                                    <input v-model="item.name" class="text-lg font-bold text-slate-800 w-full outline-none placeholder-slate-300" placeholder="Item Name">
                                    <button @click="actions.removeItem(sIdx, iIdx)" class="no-print text-slate-200 hover:text-red-500 opacity-0 group-hover/item:opacity-100"><i class="fas fa-times"></i></button>
                                </div>
                                <textarea v-model="item.desc" rows="2" class="w-full text-sm text-slate-500 outline-none resize-none bg-transparent" placeholder="Description..."></textarea>

                                <div class="mt-4">
                                    <div class="link-input-area flex gap-2 items-center mb-3 no-print">
                                        <div class="relative w-full">
                                            <i class="fas fa-link absolute left-3 top-2.5 text-slate-300 text-xs"></i>
                                            <input type="text" v-model="item.tempLink" @keydown.enter="actions.addLink(item)" 
                                                class="w-full bg-slate-50 border border-slate-200 rounded px-8 py-2 text-xs outline-none focus:border-[#0078D4]" 
                                                placeholder="Paste OneDrive Share Link here and press Enter...">
                                        </div>
                                    </div>

                                    <div class="attachment-grid grid grid-cols-1 sm:grid-cols-2 gap-2">
                                        <div v-for="(link, lIdx) in item.links" :key="lIdx" 
                                             class="attachment-item office-card rounded p-2 flex items-center gap-3 cursor-pointer group/link"
                                             @click="window.open(link.url, '_blank')">
                                            
                                            <div class="w-8 h-8 flex items-center justify-center rounded bg-slate-100 text-slate-500 flex-shrink-0">
                                                <i :class="actions.getIcon(link.url)"></i>
                                            </div>
                                            
                                            <div class="flex-grow overflow-hidden">
                                                <div class="text-[10px] font-bold text-[#0078D4] truncate uppercase tracking-wider">OneDrive Link</div>
                                                <div class="text-xs text-slate-600 truncate underline decoration-dotted">{{ link.url }}</div>
                                            </div>
                                            
                                            <button @click.stop="item.links.splice(lIdx, 1)" class="no-print text-slate-300 hover:text-red-500 p-1"><i class="fas fa-times"></i></button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="w-56 flex-shrink-0">
                                <div class="bg-slate-50 rounded p-3 border border-slate-200">
                                    <div class="internal-data space-y-1 mb-2 border-b border-slate-200 pb-2">
                                        <div class="flex justify-between items-center">
                                            <label class="text-[10px] font-bold text-slate-400">COST</label>
                                            <input type="number" v-model.number="item.cost" class="w-16 text-right text-xs bg-white border rounded px-1 outline-none">
                                        </div>
                                        <div class="flex justify-between items-center">
                                            <label class="text-[10px] font-bold text-slate-400">MARGIN %</label>
                                            <input type="number" v-model.number="item.margin" class="w-12 text-right text-xs bg-white border rounded px-1 outline-none text-green-600">
                                        </div>
                                        <div class="flex justify-between items-center">
                                            <label class="text-[10px] font-bold text-slate-400">QTY</label>
                                            <input type="number" v-model.number="item.qty" class="w-12 text-right text-xs bg-white border rounded px-1 outline-none">
                                        </div>
                                    </div>

                                    <div class="text-right">
                                        <div class="text-[10px] font-bold text-slate-400 uppercase">Unit Price</div>
                                        <div class="text-base font-black text-slate-800">${{ (item.cost * (1 + item.margin/100)).toFixed(2) }}</div>
                                        <div class="text-[10px] text-slate-400 mt-1">
                                            Sub: <span class="font-bold text-slate-900">${{ ((item.cost * (1 + item.margin/100)) * item.qty).toFixed(2) }}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <button @click="actions.addItem(sIdx)" class="no-print mt-4 w-full py-2 border border-dashed border-slate-300 rounded text-xs font-bold text-slate-400 hover:border-[#0078D4] hover:text-[#0078D4] transition">
                    + Add Item
                </button>
            </div>
            
            <button @click="actions.addSection" class="no-print mx-auto block px-6 py-2 bg-slate-800 text-white rounded text-xs font-bold hover:bg-slate-700 shadow-lg">
                + Add Section
            </button>
        </div>

        <footer class="bg-slate-50 p-10 border-t border-slate-200 page-break">
            <div class="flex justify-between items-end">
                <div class="internal-data bg-yellow-50 border border-yellow-200 rounded p-3">
                    <div class="text-[10px] font-bold text-yellow-700 uppercase mb-1">Internal Profitability</div>
                    <div class="text-xs text-yellow-900 w-32 flex justify-between"><span>Cost:</span> <span>${{ totals.cost.toFixed(2) }}</span></div>
                    <div class="text-xs text-green-700 font-bold w-32 flex justify-between"><span>Profit:</span> <span>${{ totals.profit.toFixed(2) }}</span></div>
                </div>
                
                <div class="text-right w-64 space-y-1">
                    <div class="flex justify-between text-sm font-bold text-slate-500"><span>Subtotal</span> <span>${{ totals.sell.toFixed(2) }}</span></div>
                    <div class="flex justify-between text-sm font-bold text-slate-500 border-b border-slate-200 pb-2"><span>GST (10%)</span> <span>${{ (totals.sell * 0.1).toFixed(2) }}</span></div>
                    <div class="flex justify-between items-center pt-2">
                        <span class="text-sm font-black text-slate-900 uppercase">Total AUD</span>
                        <span class="text-2xl font-black text-[#0078D4]">${{ (totals.sell * 1.1).toFixed(2) }}</span>
                    </div>
                </div>
            </div>
        </footer>
    </main>
</div>

<script>
    const { createApp, ref, computed, reactive } = Vue;

    createApp({
        setup() {
            const viewMode = ref('internal');
            const currentDate = new Date().toLocaleDateString('en-AU');
            
            const project = ref({
                title: '', client: '', ref: '',
                sections: [{ id: 1, title: 'Scope', items: [{ name: '', desc: '', cost: 0, margin: 30, qty: 1, links: [], tempLink: '' }] }]
            });

            const totals = computed(() => {
                let cost = 0, sell = 0;
                project.value.sections.forEach(s => s.items.forEach(i => {
                    const price = i.cost * (1 + i.margin/100);
                    cost += i.cost * i.qty;
                    sell += price * i.qty;
                }));
                return { cost, sell, profit: sell - cost };
            });

            const actions = {
                addSection: () => project.value.sections.push({ id: Date.now(), title: '', items: [] }),
                removeSection: (i) => { if(confirm('Delete?')) project.value.sections.splice(i, 1); },
                addItem: (sIdx) => project.value.sections[sIdx].items.push({ name: '', desc: '', cost: 0, margin: 30, qty: 1, links: [], tempLink: '' }),
                removeItem: (s, i) => project.value.sections[s].items.splice(i, 1),
                
                // 核心：添加链接
                addLink: (item) => {
                    if (!item.tempLink) return;
                    item.links.push({ url: item.tempLink, type: 'link' });
                    item.tempLink = ''; // Clear input
                },

                // 智能图标判断
                getIcon: (url) => {
                    const u = url.toLowerCase();
                    if (u.includes('.pdf')) return 'fas fa-file-pdf text-red-500';
                    if (u.includes('.xls') || u.includes('spreadsheet')) return 'fas fa-file-excel text-green-600';
                    if (u.includes('.doc') || u.includes('document')) return 'fas fa-file-word text-blue-600';
                    if (u.includes('.jpg') || u.includes('.png') || u.includes('photo')) return 'fas fa-file-image text-purple-600';
                    return 'fas fa-link text-slate-400';
                },

                saveData: () => {
                    const blob = new Blob([JSON.stringify(project.value)], { type: "application/json" });
                    const a = document.createElement('a');
                    a.href = URL.createObjectURL(blob);
                    a.download = `Quote_${project.value.title || 'New'}.json`;
                    a.click();
                },
                loadData: (e) => {
                    const r = new FileReader();
                    r.onload = (ev) => project.value = JSON.parse(ev.target.result);
                    r.readAsText(e.target.files[0]);
                },
                print: () => {
                    if(confirm("Hide internal costs for Client PDF?")) {
                        viewMode.value = 'client';
                        setTimeout(() => window.print(), 100);
                    } else window.print();
                }
            };

            return { viewMode, currentDate, project, totals, actions };
        }
    }).mount('#app');
</script>
</body>
</html>
